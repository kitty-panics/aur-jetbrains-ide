# Maintainer: Kitty Panics

pkgbase=jetbrains-rider
pkgname=(${pkgbase} ${pkgbase}-jre)
pkgver=2022.2.4
pkgrel=3
url="https://www.jetbrains.com/rider/"
pkgdesc="A cross-platform C# IDE by JetBrains."
arch=('x86_64')
license=('custom:jetbrains')
depends=('giflib' 'glib2' 'libxtst' 'libxrender')
makedepends=('rsync')
options=('!strip')
_tar_gz="JetBrains.Rider-${pkgver}.tar.gz"
install="${pkgbase}.install"
source=("https://download.jetbrains.com/rider/${_tar_gz}"
        "${pkgbase}.desktop"
        "${pkgbase}.install"
        "LICENSE")
sha256sums=('SKIP'
            '19bbc8d9bd95e6525bccc7ae9b1644c1f4c757f88fbd8f2a2777832c6422877f'
            'ec4c58e5e3636feb9ab106229bf29abe6c6117eb73f1a36fdf2a35c4e7e98fe0'
            'c37db68dbedb20617a23cf1299cd95e7f114f019ff7f44877409cef916ff6ab1')
noextract=("${_tar_gz}")

prepare() {
    install -dm755 "${srcdir}"/opt/"${pkgbase}"/
    bsdtar --strip-components 1 -xf "${_tar_gz}" -C "${srcdir}"/opt/"${pkgbase}"
}

package_jetbrains-rider() {
    provides=("${pkgname}")
    conflicts=("${pkgname}")
    backup=("opt/${pkgname}/bin/idea.properties"
            "opt/${pkgname}/bin/${pkgbase##*-}64.vmoptions")
    optdepends=('jetbrains-rider-jre: JetBrains custom Java Runtime (Recommended)'
                'java-runtime:     JRE - Required if jetbrains-rider-jre is not installed'
                'libdbusmenu-glib: For global menu support'
                'gnome-keyring:    Save login/deployment credentials safely'
                'java-openjfx:     Rendering Markdown files'
                'mono:             .NET runtime'
                'msbuild:          Build .NET Core projects')

    # create dir
    install -dm755 "${pkgdir}"/opt/
    install -dm755 "${pkgdir}"/usr/bin/
    install -dm755 "${pkgdir}"/usr/share/applications/
    install -dm755 "${pkgdir}"/usr/share/doc/
    install -dm755 "${pkgdir}"/usr/share/icons/hicolor/{128x128,scalable}/apps/
    install -dm755 "${pkgdir}"/usr/share/pixmaps/
    install -dm755 "${pkgdir}"/usr/share/licenses/"${pkgname}"/

    # package files
    rsync -rtl "${srcdir}/opt" "${pkgdir}" \
          --exclude=/opt/${pkgname}/jbr \
    # /usr/bin/
    ln -s "/opt/${pkgname}/bin/${pkgbase##*-}.sh" \
          "${pkgdir}/usr/bin/${pkgname}"

    # .desktop
    install -Dm644 "${srcdir}/${pkgname}.desktop" \
                   "${pkgdir}/usr/share/applications/${pkgname}.desktop"
    # doc
    ln -s "/opt/${pkgname}/help" \
          "${pkgdir}/usr/share/doc/${pkgname}"
    # icons/hicolor
    install -Dm644 "${pkgdir}/opt/${pkgname}/bin/${pkgbase##*-}.png" \
                   "$pkgdir/usr/share/icons/hicolor/128x128/apps/${pkgname}.png"
    install -Dm644 "${pkgdir}/opt/${pkgname}/bin/${pkgbase##*-}.svg" \
                   "$pkgdir/usr/share/icons/hicolor/scalable/apps/${pkgname}.svg"
    # pixmaps
    install -Dm644 "${pkgdir}/opt/${pkgname}/bin/${pkgbase##*-}.svg" \
                   "${pkgdir}/usr/share/pixmaps/${pkgname}.svg"
    # licenses
    install -Dm644 "${srcdir}/LICENSE" \
                   "${pkgdir}/usr/share/licenses/${pkgname}/LICENSE"
}

package_jetbrains-rider-jre() {
    pkgdesc='JetBrains Runtime (JBR) for Rider - a patched JRE'
    provides=("${pkgname}")
    conflicts=("${pkgname}")

    # create dir
    install -dm755 "${pkgdir}/opt/${pkgbase}/"
    # package files
    rsync -rtl "${srcdir}/opt/${pkgbase}/jbr" "${pkgdir}/opt/${pkgbase}"
}
